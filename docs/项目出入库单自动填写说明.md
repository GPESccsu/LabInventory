# 项目出入库单自动填写说明

> 适用版本：包含 `proj-forms` 命令的 `inv.py/app/inv.py`。

## 1. 目标

本功能用于**按项目**自动生成两类单据：

- **出库单（领用出库单）**：
  - 数据来源：项目 BOM（`project_bom`）
  - 特别规则：**数量列留空**，后续由人工填写
  - 作用：先形成纸面/电子领用记录，再根据实际填写数量执行出库动作

- **入库单（入库验收单）**：
  - 优先来源：立创导出文件（`csv/xlsx/xls`）
  - 备选来源：若未提供立创文件，则按项目 BOM 需求数量生成
  - 作用：用于项目采购到货后的验收入库记录

---

## 2. 命令总览

```bash
python inv.py --db <数据库路径> proj-forms \
  --proj <项目代码> \
  --outbound-csv <出库单CSV路径> \
  --inbound-csv <入库单CSV路径> \
  [--lcsc-file <立创导出文件>] \
  [--apply-inbound --inbound-loc <入库库位>]
```

### 参数说明

- `--proj`：项目代码（如 `PJ-001`）
- `--outbound-csv`：出库单导出路径
- `--inbound-csv`：入库单导出路径
- `--lcsc-file`：立创导出文件（支持 `csv/xlsx/xls`），用于填充入库单
- `--apply-inbound`：将入库单数量直接写入库存（可选）
- `--inbound-loc`：执行 `--apply-inbound` 时必须提供的库位

---

## 3. 使用场景

## 场景 A：仅生成单据（推荐日常流程）

```bash
python inv.py --db ./lab_inventory.db proj-forms \
  --proj PJ-001 \
  --outbound-csv ./out/PJ-001-出库单.csv \
  --inbound-csv ./out/PJ-001-入库单.csv \
  --lcsc-file ./BoM报价-立创_20260212.xlsx
```

适合：先由系统整理单据，再由管理员人工补充/审核。

## 场景 B：生成单据 + 直接入库

```bash
python inv.py --db ./lab_inventory.db proj-forms \
  --proj PJ-001 \
  --outbound-csv ./out/PJ-001-出库单.csv \
  --inbound-csv ./out/PJ-001-入库单.csv \
  --lcsc-file ./BoM报价-立创_20260212.xlsx \
  --apply-inbound --inbound-loc C409-G01-S01-P01
```

适合：已确认到货数量无误，且希望一键写入库存。

---

## 4. 出库单与入库单字段说明

## 4.1 出库单 CSV 列

- 序号
- 时间
- 名称
- 型号规格
- 单位
- 数量（**留空**）
- 单价(元)
- 总额(元)
- 领用人
- 领用时间
- 用途
- 项目

> 说明：出库单的数量、领用人、用途等可由人工后续填写。

## 4.2 入库单 CSV 列

- 序号
- 时间
- 名称
- 型号规格
- 单位
- 数量
- 单价(元)
- 总额(元)
- 项目

---

## 5. 立创字段映射（入库单）

程序会自动尝试以下列名（含常见别名）：

- 型号：`型号` / `Manufacturer Part` / `MPN` / `mpn`
- 名称：`商品名称` / `Name` / `名称`
- 数量：`购买数量` / `数量` / `Quantity` / `qty`
- 单价：`单价(RMB)` / `单价` / `price`
- 总额：`小计(RMB)` / `总价` / `total`
- 封装：`封装` / `Footprint 封装` / `Footprint` / `package`

如果总额缺失且单价与数量可用，则自动计算：

`总额 = 数量 × 单价`

---

## 6. 数据来源与规则

- 出库单来源：`projects + project_bom + parts`
- 入库单来源：
  1. 有 `--lcsc-file`：按立创导出文件解析
  2. 无 `--lcsc-file`：按项目 BOM 需求数量生成
- `--apply-inbound` 写库规则：
  - 若物料不存在，会先自动创建基础物料信息
  - 然后按 `--inbound-loc` 将数量写入库存

---

## 7. 推荐业务流程（与你当前要求一致）

1. 项目建立 BOM
2. 生成出库单（数量留空）
3. 人工填写本次实际出库数量
4. 再执行出库扣减（建议基于填写后的结果进行）
5. 到货后使用立创数据生成入库单
6. 审核无误后执行入库（可用 `--apply-inbound`）

---

## 8. 常见问题

## Q1：报错“执行入库写库时必须提供 --inbound-loc”

A：你启用了 `--apply-inbound`，但未指定 `--inbound-loc`。补上库位参数即可。

## Q2：Excel 无法读取

A：请确认环境已安装 `pandas`，或将文件先另存为 `csv` 后再导入。

## Q3：为什么出库单数量是空白？

A：这是刻意设计，符合“先出单、后人工填写数量、再按实际数量出库”的流程要求。

---

## 9. 后续可扩展建议

- 增加“按填写后的出库单 CSV 一键扣减库存”命令
- 增加“单据导出为 xlsx 并套用固定格式模板”
- 增加“按项目统计出入库金额与执行进度”报表



## 10. 失败提示说明（新增）

- 项目不存在：
  - 提示：`执行失败：项目不存在：<code>。请先执行 proj-new 或确认 --proj 参数。`
- 项目存在但没有 BOM 且没有预留：
  - 提示：`执行失败：项目 <code> 没有 BOM，也没有预留记录，无法生成单据。请先执行 bom-set 或 reserve。`

> 新版本已将这两类错误改为友好提示，不再输出 Python Traceback。
